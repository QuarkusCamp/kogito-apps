<!DOCTYPE html>
<html>

<head>
    <link rel="stylesheet" href="https://unpkg.com/@patternfly/patternfly/patternfly.css" crossorigin="anonymous">
    <script>
        const settings = {};

        // Default form handler based on JSON schema impl feel free to change it to meet your needs!
        class FormHandler {
            constructor(model, schema, namespace) {
                this.model = model;
                this.schema = schema;
                this.namespace = namespace;
                this.proxy = new Proxy(model, {
                    get: (target, prop, receiver) => {
                        return target[prop];
                    },
                    set: (target, prop, value) => {
                        target[prop] = value;
                        return true;
                    }
                });
                this.doBind();
            }

            doBind() {
                Object.entries(this.schema.properties).forEach(([key, element]) => {
                    if (element.type === 'array') {
                        console.log(`Cannot bind property "${key}" type ${element.type} not supported yet`);
                    } else if (element.type === 'object') {
                        if (!this.proxy[key]) {
                            this.proxy[key] = {};
                        }
                        const newNamesPace = this.namespace ? this.namespace + "___" + key : key;
                        const nestedHandler = new FormHandler(this.proxy[key], element, newNamesPace);
                    } else {
                        this.bindInputProperty(key)
                    }
                });
            }
            bindProperty(property) {
                Object.defineProperty(proxy, property, {
                    get() {
                        return model[property];
                    },
                    set(newValue) {
                        model[property] = newValue;
                    }
                });
            };


            bindInputProperty(property) {
                const bindingId = this.namespace ? this.namespace + "___" + property : property;
                const element = document.getElementById(bindingId);
                if (!element) {
                    console.log(`Cannot find input to bind property to "${property}".`);
                    return;
                }
                if (element.type === 'chekcbox') {
                    element.addEventListener("click", event => this.proxy[property] = event.target.value)
                } else {
                    element.addEventListener("change", event => {
                        this.proxy[property] = event.target.value
                    });
                }
                if(element.type === 'datetime-local') {
                   const dateValue = this.proxy[property]
                    if (dateValue) {
                        this.proxy[property] = new Date(dateValue).toISOString().slice(0, -8);
                    }
                }
                if (this.proxy[property]) {
                    element.value = this.proxy[property];
                }
            }

        }

        function init() {
            const fetchData = (endpoint, dataConsummer) => {
                fetch(endpoint)
                    .then(response => {
                        if(response.ok) {
                            response.json()
                                .then(data => dataConsummer(data));
                        } else {
                            console.error(`Cannot load data from "${endpoint}", response: ${response.statusText}`);
                        }
                    }).catch(error => console.error(`Cannot load data from "${endpoint}", error: ${error}`));
            }


            let params = new URLSearchParams(location.search);

            let endpoint = params.get('endpoint');

            settings.endpoint = endpoint;

            // Fetching form data from task endpoint
            fetchData(endpoint, data => {
                settings.data = data;

                console.log(`Found data: ${data}`)
                // Fetching form info 
                const formsEndpoint = endpoint + (!endpoint.endsWith("/") ? "/" : "") + "form"
                fetchData(formsEndpoint, form => {
                    settings.form = form;
                    handler = new FormHandler(settings.data, settings.form.schema);
                })
            });
        }

        function doSubmit() {
            console.log(JSON.stringify(settings.data));
        }

    </script>
</head>

<body onload="init()">
    <form novalidate="" class="pf-c-form" href="#" onsubmit="return false;">
        <div>
            <label>Fligth</label>
            <div class="pf-c-form__group">
                <label class="pf-c-form__label" for="flight___flightNumber">
                    <span class="pf-c-form__label-text">Flight number</span>
                </label>
                <input type="text" id="flight___flightNumber" name="flight___flightNumber" class="pf-c-form-control" value="" aria-invalid="false" />
            </div>
            <div class="pf-c-form__group">
                <label class="pf-c-form__label" for="flight___seat">
                    <span class="pf-c-form__label-text">Seat</span>
                </label>
                <input type="text" id="flight___seat" name="flight___seat" placeholder="" class="pf-c-form-control" value="" aria-invalid="false" />
            </div>
            <div class="pf-c-form__group">
                <label class="pf-c-form__label" for="flight___gate">
                    <span class="pf-c-form__label-text">Gate</span>
                </label>
                <input type="text" id="flight___gate" name="flight___gate" placeholder="" class="pf-c-form-control" value="" aria-invalid="false" />
            </div>
            <div class="pf-c-form__group">
                <label class="pf-c-form__label" for="flight___departure">
                    <span class="pf-c-form__label-text">Departure</span>
                </label>
                <input type="datetime-local" id="flight___departure" name="flight___departure" placeholder="" class="pf-c-form-control" value="" aria-invalid="false" />
            </div>
            <div class="pf-c-form__group">
                <label class="pf-c-form__label" for="flight___arrival">
                    <span class="pf-c-form__label-text">Arrival</span>
                </label>
                <input type="datetime-local" id="flight___arrival" name="flight___arrival" placeholder="" class="pf-c-form-control" value="" aria-invalid="false" />
            </div>
        </div>
        <div>
            <label>Hotel</label>
            <div class="pf-c-form__group">
                <label class="pf-c-form__label" for="hotel___name">
                    <span class="pf-c-form__label-text">Name</span>
                </label>
                <input type="text" id="hotel___name" name="hotel___name" class="pf-c-form-control" value="" aria-invalid="false" />
            </div>
            <div>
                <label>Address</label>
                <div class="pf-c-form__group">
                    <label class="pf-c-form__label" for="hotel___address___street">
                        <span class="pf-c-form__label-text">Street</span>
                    </label>
                    <input type="text" id="hotel___address___street" name="hotel___address___street" class="pf-c-form-control" value="" aria-invalid="false" />
                </div>
                <div class="pf-c-form__group">
                    <label class="pf-c-form__label" for="hotel___address___city">
                        <span class="pf-c-form__label-text">City</span>
                    </label>
                    <input type="text" id="hotel___address___city" name="hotel___address___city" class="pf-c-form-control" value="" aria-invalid="false" />
                </div>
                <div class="pf-c-form__group">
                    <label class="pf-c-form__label" for="hotel___address___zipCode">
                        <span class="pf-c-form__label-text">Zip Code</span>
                    </label>
                    <input type="text" id="hotel___address___zipCode" name="hotel___address___zipCode" class="pf-c-form-control" value="" aria-invalid="false" />
                </div>
                <div class="pf-c-form__group">
                    <label class="pf-c-form__label" for="hotel___address___country">
                        <span class="pf-c-form__label-text">Street</span>
                    </label>
                    <input type="text" id="hotel___address___country" name="hotel___address___country" class="pf-c-form-control" value="" aria-invalid="false" />
                </div>
            </div>
            <div class="pf-c-form__group">
                <label class="pf-c-form__label" for="hotel___phone">
                    <span class="pf-c-form__label-text">Phone</span>
                </label>
                <input type="text" id="hotel___phone" name="hotel___phone" placeholder="" class="pf-c-form-control" value="" aria-invalid="false" />
            </div>
            <div class="pf-c-form__group">
                <label class="pf-c-form__label" for="hotel___bookingNumber">
                    <span class="pf-c-form__label-text">Booking Number</span>
                </label>
                <input type="text" id="hotel___bookingNumber" name="hotel___bookingNumber" placeholder="" class="pf-c-form-control" value="" aria-invalid="false" />
            </div>
            <div class="pf-c-form__group">
                <label class="pf-c-form__label" for="hotel___room">
                    <span class="pf-c-form__label-text">Room</span>
                </label>
                <input type="text" id="hotel___room" name="hotel___room" placeholder="" class="pf-c-form-control" value="" aria-invalid="false" />
            </div>
        </div>
        <!--
        <div class="pf-c-form__group">
            <label class="pf-c-form__label" for="type">
                <span class="pf-c-form__label-text">Last name</span>
            </label>
            <select id="type" name="type" class="pf-c-form-control" value="" aria-invalid="false">
                <option value="developer">Developer</option>
                <option value="human">Human</option>
            </select>
        </div>
        <div>
            <label>Friend</label>
            <div class="pf-c-form__group">
                <label class="pf-c-form__label" for="friend___name">
                    <span class="pf-c-form__label-text">Name</span>
                </label>
                <input type="text" id="friend___name" name="friend___name" placeholder="name" class="pf-c-form-control"
                    value="" aria-invalid="false" />
            </div>
            <div class="pf-c-form__group">
                <label class="pf-c-form__label" for="age">
                    <span class="pf-c-form__label-text">Age</span>
                </label>
                <input type="number" name="friend___age" id="friend___age" placeholder="" step="1"
                    class="pf-c-form-control" aria-invalid="false" />
            </div>
        </div>-->
        <div class="pf-c-form__group pf-m-action">
            <div class="pf-c-form__actions">
                <button class="pf-c-button pf-m-primary" onclick="doSubmit()">Submit</button>
            </div>
        </div>
    </form>
</body>

</html>